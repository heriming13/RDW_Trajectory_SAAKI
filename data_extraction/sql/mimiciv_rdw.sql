WITH 
LAB1 AS
	(SELECT SUBJECT.STAY_ID,
	-- 实验室指标_红细胞分布宽度
	AVG(CASE WHEN LAB.ITEMID = 51277 THEN VALUENUM END) AS LAB_24HOUR_labRDW,
	MAX(CASE WHEN LAB.ITEMID = 51277 THEN VALUEUOM END) AS LAB_24HOUR_labRDW_UOM
		FROM WORK.mimiciv3_subject AS SUBJECT
		LEFT JOIN MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU ON SUBJECT.HADM_ID = ICU.HADM_ID
		LEFT JOIN MIMICIV_HOSP.LABEVENTS AS LAB ON SUBJECT.HADM_ID = LAB.HADM_ID
		WHERE LAB.ITEMID IN (51277)
			AND LAB.CHARTTIME BETWEEN ICU_INTIME + INTERVAL '0' HOUR AND ICU_INTIME + INTERVAL '24' HOUR
		GROUP BY SUBJECT.STAY_ID),
LAB2 AS
	(SELECT SUBJECT.STAY_ID,
	-- 实验室指标_红细胞分布宽度
	AVG(CASE WHEN LAB.ITEMID = 51277 THEN VALUENUM END) AS LAB_24HOUR_labRDW,
	MAX(CASE WHEN LAB.ITEMID = 51277 THEN VALUEUOM END) AS LAB_24HOUR_labRDW_UOM
		FROM WORK.mimiciv3_subject AS SUBJECT
		LEFT JOIN MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU ON SUBJECT.HADM_ID = ICU.HADM_ID
		LEFT JOIN MIMICIV_HOSP.LABEVENTS AS LAB ON SUBJECT.HADM_ID = LAB.HADM_ID
		WHERE LAB.ITEMID IN (51277)
			AND LAB.CHARTTIME BETWEEN ICU_INTIME + INTERVAL '24' HOUR AND ICU_INTIME + INTERVAL '48' HOUR
		GROUP BY SUBJECT.STAY_ID),
LAB3 AS
	(SELECT SUBJECT.STAY_ID,
	-- 实验室指标_红细胞分布宽度
	AVG(CASE WHEN LAB.ITEMID = 51277 THEN VALUENUM END) AS LAB_24HOUR_labRDW,
	MAX(CASE WHEN LAB.ITEMID = 51277 THEN VALUEUOM END) AS LAB_24HOUR_labRDW_UOM
		FROM WORK.mimiciv3_subject AS SUBJECT
		LEFT JOIN MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU ON SUBJECT.HADM_ID = ICU.HADM_ID
		LEFT JOIN MIMICIV_HOSP.LABEVENTS AS LAB ON SUBJECT.HADM_ID = LAB.HADM_ID
		WHERE LAB.ITEMID IN (51277)
			AND LAB.CHARTTIME BETWEEN ICU_INTIME + INTERVAL '48' HOUR AND ICU_INTIME + INTERVAL '72' HOUR
		GROUP BY SUBJECT.STAY_ID),
LAB4 AS
	(SELECT SUBJECT.STAY_ID,
	-- 实验室指标_红细胞分布宽度
	AVG(CASE WHEN LAB.ITEMID = 51277 THEN VALUENUM END) AS LAB_24HOUR_labRDW,
	MAX(CASE WHEN LAB.ITEMID = 51277 THEN VALUEUOM END) AS LAB_24HOUR_labRDW_UOM
		FROM WORK.mimiciv3_subject AS SUBJECT
		LEFT JOIN MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU ON SUBJECT.HADM_ID = ICU.HADM_ID
		LEFT JOIN MIMICIV_HOSP.LABEVENTS AS LAB ON SUBJECT.HADM_ID = LAB.HADM_ID
		WHERE LAB.ITEMID IN (51277)
			AND LAB.CHARTTIME BETWEEN ICU_INTIME + INTERVAL '72' HOUR AND ICU_INTIME + INTERVAL '96' HOUR
		GROUP BY SUBJECT.STAY_ID),
LAB5 AS
	(SELECT SUBJECT.STAY_ID,
	-- 实验室指标_红细胞分布宽度
	AVG(CASE WHEN LAB.ITEMID = 51277 THEN VALUENUM END) AS LAB_24HOUR_labRDW,
	MAX(CASE WHEN LAB.ITEMID = 51277 THEN VALUEUOM END) AS LAB_24HOUR_labRDW_UOM
		FROM WORK.mimiciv3_subject AS SUBJECT
		LEFT JOIN MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU ON SUBJECT.HADM_ID = ICU.HADM_ID
		LEFT JOIN MIMICIV_HOSP.LABEVENTS AS LAB ON SUBJECT.HADM_ID = LAB.HADM_ID
		WHERE LAB.ITEMID IN (51277)
			AND LAB.CHARTTIME BETWEEN ICU_INTIME + INTERVAL '96' HOUR AND ICU_INTIME + INTERVAL '120' HOUR
		GROUP BY SUBJECT.STAY_ID)

SELECT DISTINCT(SUBJECT.SUBJECT_ID),SUBJECT.STAY_ID,SUBJECT.HADM_ID,

	ROUND(LAB1.LAB_24HOUR_labRDW::numeric,2) AS LAB1_labRDW,
	LAB1.LAB_24HOUR_labRDW_UOM AS LAB1_labRDW_UOM,
	ROUND(LAB2.LAB_24HOUR_labRDW::numeric,2) AS LAB2_labRDW,
	LAB2.LAB_24HOUR_labRDW_UOM AS LAB2_labRDW_UOM,
	ROUND(LAB3.LAB_24HOUR_labRDW::numeric,2) AS LAB3_labRDW,
	LAB3.LAB_24HOUR_labRDW_UOM AS LAB3_labRDW_UOM,
	ROUND(LAB4.LAB_24HOUR_labRDW::numeric,2) AS LAB4_labRDW,
	LAB4.LAB_24HOUR_labRDW_UOM AS LAB4_labRDW_UOM,
	ROUND(LAB5.LAB_24HOUR_labRDW::numeric,2) AS LAB5_labRDW,
	LAB5.LAB_24HOUR_labRDW_UOM AS LAB5_labRDW_UOM
FROM WORK.mimiciv3_subject AS SUBJECT
LEFT JOIN LAB1 ON SUBJECT.STAY_ID = LAB1.STAY_ID
LEFT JOIN LAB2 ON SUBJECT.STAY_ID = LAB2.STAY_ID
LEFT JOIN LAB3 ON SUBJECT.STAY_ID = LAB3.STAY_ID
LEFT JOIN LAB4 ON SUBJECT.STAY_ID = LAB4.STAY_ID
LEFT JOIN LAB5 ON SUBJECT.STAY_ID = LAB5.STAY_ID

ORDER BY SUBJECT.SUBJECT_ID

