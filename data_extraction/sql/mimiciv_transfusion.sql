WITH 
-- 给药数据_输血
transfusion AS
(SELECT DISTINCT(PRESCRIPTIONS.HADM_ID),
			1 AS FLAG
		FROM MIMICIV_HOSP.PRESCRIPTIONS AS PRESCRIPTIONS,
 		MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU,
			WORK.mimiciv3_subject AS SUBJECT
		WHERE PRESCRIPTIONS.HADM_ID = SUBJECT.HADM_ID 
 		AND SUBJECT.STAY_ID = ICU.STAY_ID
 		AND PRESCRIPTIONS.STARTTIME >= ICU.ICU_INTIME
	 	AND PRESCRIPTIONS.GSN in ('220970','225170','226369','226370','227532','227071','221733')
	GROUP BY PRESCRIPTIONS.HADM_ID
	),
transfusion_val  AS
(SELECT DISTINCT(PRESCRIPTIONS.HADM_ID),
     SUM(CAST(PRESCRIPTIONS.dose_val_rx AS NUMERIC)) AS dose_val_rx,
 		  MAX(PRESCRIPTIONS.dose_unit_rx) AS dose_unit_rx
		FROM MIMICIV_HOSP.PRESCRIPTIONS AS PRESCRIPTIONS,
 		MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU,
			WORK.mimiciv3_subject AS SUBJECT
		WHERE PRESCRIPTIONS.HADM_ID = SUBJECT.HADM_ID 
 		AND SUBJECT.STAY_ID = ICU.STAY_ID
 		AND PRESCRIPTIONS.STARTTIME >= ICU.ICU_INTIME
	 	AND PRESCRIPTIONS.GSN in ('220970','225170','226369','226370','227532','227071','221733')
 		AND PRESCRIPTIONS.dose_val_rx ~ '^[0-9]+(\.[0-9]+)?$'
	GROUP BY PRESCRIPTIONS.HADM_ID
	)

SELECT DISTINCT(SUBJECT.SUBJECT_ID),SUBJECT.STAY_ID,SUBJECT.HADM_ID,

transfusion.FLAG AS transfusion,transfusion_val.dose_val_rx AS transfusionTotalVal,transfusion_val.dose_unit_rx AS transfusionUnit
	FROM WORK.mimiciv3_subject AS SUBJECT
LEFT JOIN transfusion ON SUBJECT.HADM_ID = transfusion.HADM_ID
LEFT JOIN transfusion_val ON SUBJECT.HADM_ID = transfusion_val.HADM_ID

ORDER BY SUBJECT.SUBJECT_ID

