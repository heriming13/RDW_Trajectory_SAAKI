-- 查找符合条件的病人,表存在work模块 
SET SEARCH_PATH TO work;

-- 生成物化视图mimiciv3_subject用来存放患者ID
DROP TABLE IF EXISTS mimiciv3_subject;

CREATE TABLE mimiciv3_subject AS 

WITH 
-- 纳入诊断为_脓毒症的患者
sepsis AS (
SELECT DISTINCT(ICU.HADM_ID) FROM MIMICIV_DERIVED.SEPSIS3,MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU
	WHERE SEPSIS3 = TRUE AND SEPSIS3.STAY_ID = ICU.STAY_ID),
-- 纳入诊断为_急性肾损伤的患者
aki AS (
SELECT DISTINCT(ICU.HADM_ID) FROM MIMICIV_DERIVED.KDIGO_STAGES,MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU
	WHERE AKI_STAGE > 0 AND KDIGO_STAGES.STAY_ID = ICU.STAY_ID),

 -- 获取疾病纳排后的患者
SUBJECT_ALL AS (SELECT DISTINCT(sepsis.HADM_ID)
	FROM sepsis,aki
	WHERE sepsis.HADM_ID=aki.HADM_ID  )

 -- 加入其他条件 	
SELECT DISTINCT(ICU.SUBJECT_ID),ICU.STAY_ID,ICU.HADM_ID
FROM MIMICIV_DERIVED.ICUSTAY_DETAIL AS ICU,MIMICIV_DERIVED.AGE AS AGE,SUBJECT_ALL 
	WHERE AGE.HADM_ID = ICU.HADM_ID
 	AND SUBJECT_ALL.HADM_ID = ICU.HADM_ID
	-- 首次入ICU
	AND ICU.FIRST_ICU_STAY = true
	AND ICU.FIRST_HOSP_STAY = true
	-- 年龄限制
	AND AGE.AGE BETWEEN 18.0 AND 100.0;

COMMENT ON TABLE mimiciv3_subject IS '2025-09-06';


-- 生成HADM_ID索引
CREATE INDEX mimiciv3_subject_hadm_id
  ON mimiciv3_subject (hadm_id);

-- 生成STAY_ID索引
CREATE INDEX mimiciv3_subject_stay_id
  ON mimiciv3_subject (stay_id); 

 SELECT * FROM work.mimiciv3_subject;

